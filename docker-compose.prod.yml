version: '3.8'

services:
  # Signal CLI REST API - handles Signal messaging
  signal-cli-rest-api:
    image: bbernhard/signal-cli-rest-api:latest
    container_name: signal-cli-rest-api
    ports:
      - "8080:8080"
    volumes:
      - signal_cli_data:/home/.local/share/signal-cli
    environment:
      - MODE=json-rpc
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/about"]
      interval: 30s
      timeout: 10s
      retries: 3

  # WAHA - WhatsApp HTTP API
  waha:
    image: devlikeapro/whatsapp-http-api:latest
    container_name: waha
    ports:
      - "3000:3000"
    volumes:
      - waha_data:/app/data
    environment:
      - WHATSAPP_HOOK_URL=http://whatsignal:8082/webhook/whatsapp
      - WHATSAPP_HOOK_EVENTS=message
      - WHATSAPP_API_KEY=${WHATSAPP_API_KEY:-your-api-key}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # WhatSignal - main bridge application (uses pre-built image)
  whatsignal:
    image: ghcr.io/bikemazzell/whatsignal:latest
    container_name: whatsignal
    ports:
      - "8082:8082"
    volumes:
      - ./config.json:/app/config.json:ro
      - whatsignal_cache:/app/cache
      - whatsignal_data:/app/data
    environment:
      # Load from .env file or use defaults
      - WHATSAPP_API_KEY=${WHATSAPP_API_KEY}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - WHATSIGNAL_ENABLE_ENCRYPTION=${WHATSIGNAL_ENABLE_ENCRYPTION:-true}
      - WHATSIGNAL_ENCRYPTION_SECRET=${WHATSIGNAL_ENCRYPTION_SECRET}
    depends_on:
      signal-cli-rest-api:
        condition: service_healthy
      waha:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - default

networks:
  default:
    driver: bridge

volumes:
  signal_cli_data:
  waha_data:
  whatsignal_data:
  whatsignal_cache: