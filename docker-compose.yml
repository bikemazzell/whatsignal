version: '3.8'

services:
  # Signal CLI REST API - handles Signal messaging
  # Note: change /mnt/data/ to your desired storage folder
  signal-cli-rest-api:
    image: bbernhard/signal-cli-rest-api:latest
    container_name: signal-cli-rest-api
    restart: unless-stopped
    read_only: false
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    ports:
      - "8081:8080"
    volumes:
      - ${WHATSIGNAL_DATA_DIR:-./data}/signal-cli-waha:/home/.local/share/signal-cli
      - signal_attachments:/var/lib/signal-cli-rest-api/attachments:rw
    tmpfs:
      - /tmp:size=100M,mode=1777
    environment:
      - MODE=native
      - AUTO_RECEIVE_SCHEDULE=0 */6 * * *
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/about"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # WAHA - WhatsApp HTTP API
  # Note: change /mnt/data/ to your desired storage folder
  waha:
    image: devlikeapro/whatsapp-http-api:latest
    container_name: waha
    restart: unless-stopped
    read_only: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    ports:
      - "3000:3000"
    volumes:
      - ${WHATSIGNAL_DATA_DIR:-./data}/waha/sessions:/app/data
    tmpfs:
      - /tmp:size=200M,mode=1777
      - /var/tmp:size=50M,mode=1777
      - /dev/shm:size=2G,mode=1777
      - /var/crashes:size=100M,mode=1777
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
    environment:
      - WHATSAPP_HOOK_URL=http://whatsignal:8082/webhook/whatsapp
      - WHATSAPP_HOOK_EVENTS=message,message.reaction,message.edited,message.ack,message.waiting
      - WHATSAPP_API_KEY=${WHATSAPP_API_KEY:-your-api-key}
      - PUPPETEER_ARGS=--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage --disable-background-timer-throttling --disable-backgrounding-occluded-windows --disable-renderer-backgrounding --crash-dumps-dir=/var/crashes
    healthcheck:
      test: ["CMD-SHELL", "curl -f -H \"X-Api-Key: $$WHATSAPP_API_KEY\" http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # WhatSignal - main bridge application
  # Note: change /mnt/data/ to your desired storage folder
  whatsignal:
    image: ghcr.io/bikemazzell/whatsignal:latest
    container_name: whatsignal
    restart: unless-stopped
    read_only: true
    user: "1000:1000"
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    ports:
      - "8083:8082"
    volumes:
      # Replace with the folder path to where your WhatSignal configuration will be stored
      - ${WHATSIGNAL_DATA_DIR:-./data}/whatsignal/config.json:/app/config.json:ro
      - ${WHATSIGNAL_DATA_DIR:-./data}/whatsignal/data:/app/data
      - signal_attachments:/app/signal-attachments:rw
    tmpfs:
      - /tmp:size=100M,mode=1777
      - /var/cache:size=50M,mode=1777
    environment:
      # Load from .env file or use defaults
      - WHATSAPP_API_KEY=${WHATSAPP_API_KEY}
      - WHATSIGNAL_WHATSAPP_WEBHOOK_SECRET=${WHATSIGNAL_WHATSAPP_WEBHOOK_SECRET}
      - WHATSIGNAL_ENABLE_ENCRYPTION=${WHATSIGNAL_ENABLE_ENCRYPTION:-true}
      - WHATSIGNAL_ENCRYPTION_SECRET=${WHATSIGNAL_ENCRYPTION_SECRET}
      # Optional: Override API URLs if needed (e.g., for external access)
      - WHATSAPP_API_URL=${WHATSAPP_API_URL:-}
      - SIGNAL_RPC_URL=${SIGNAL_RPC_URL:-}
    depends_on:
      waha:
        condition: service_healthy
      signal-cli-rest-api:
        condition: service_healthy

# Named volumes for data persistence
volumes:
  signal_cli_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WHATSIGNAL_DATA_DIR:-./data}/signal-cli
  signal_attachments:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WHATSIGNAL_DATA_DIR:-./data}/signal-attachments
  waha_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WHATSIGNAL_DATA_DIR:-./data}/waha
  whatsignal_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WHATSIGNAL_DATA_DIR:-./data}/whatsignal
  whatsignal_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WHATSIGNAL_DATA_DIR:-./data}/media-cache
  whatsignal_attachments:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WHATSIGNAL_DATA_DIR:-./data}/signal-attachments




